# Day 5

## Lab - Implementing a custom Terraform Provider using Golang

You need to create a folder
```
mkdir -p ~/go/bin
touch ~/.terraformrc
```

Paste the below code in your ~/.terraformrc file
<pre>
provider_installation {	
    dev_overrides {
    	"registry.terraform.io/tektutor/file" = "/home/student/go/bin",
    }
    direct{}
}  
</pre>

Then you may proceed with the below instructions
```
cd ~/terraform-sep2226-2025
git pull
cd Day5/custom-terraform-providers/
tree
cd file

go mod init github.com/tektutor/terraform-provider-file
go mod tidy
ls -l
go build
ls -l
go install
ls -l
ls -l ~/go/bin
```
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/7a4da1c2-fe2b-4938-b129-88bbd5eac51c" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/5c59e9e3-790e-4d3b-ba9c-b31ab4dde677" />


## Lab - Using our custom teraform file provider in our Terraform project
```
cd ~/terraform-sep2226-2025
git pull
cd Day5/custom-terraform-providers/test-file-custom-terraform-provider
ls -l
terraform plan
terraform apply --auto-approve
ls -l
cat terraform.tfstate
cat myfile.txt
```
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/b577fb44-7d09-47d4-a5b1-619d173e47b0" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/9677dc67-ffc8-4eae-9bb9-2a160bdb1d2b" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/4c3a460f-63d9-48c1-bdd2-64bc116aad7a" />

Now update your main.tf as shown below
<pre>
terraform {
    required_providers {
        localfile = {
		      source = "tektutor/file"
	      }
    }
}

resource "localfile" "myfile" {
   file_name = "./myfile.txt"
   file_content = "Test file revised - generated by terraform."
}    
</pre>

<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/63c38cbc-582c-4cf2-8644-ed8cb4e5f2b7" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/ed060833-cb8b-41a8-b903-886907835fdb" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/15514292-aed1-41fe-a961-c069cda6ccc3" />

Also see if we are able to delete the file provisioned by terraform
```
ls -l
cat myfile.txt
terraform show
terraform destroy --auto-approve
```
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/8c0e2d1b-9465-47c4-a783-1cf576361483" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/523bc9dd-fbbb-48d6-91bf-cddf989e469c" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/bcc19575-a480-4c6c-81b4-017fa7136611" />

## Lab - Creating a custom terraform docker provider in golang
Update your ~/.terraformrc file as shown below
<pre>
provider_installation {	
    dev_overrides {
    	"registry.terraform.io/tektutor/file" = "/home/student/go/bin",
    	"registry.terraform.io/tektutor/docker" = "/home/student/go/bin",
    }
    direct{}
}  
</pre>	

You can build the terraform docker provider and install it
```
cd ~/terraform-sep2226-2025
git pull
cd Day5/custom-terraform-providers/docker
tree
go mod init github.com/tektutor/terraform-provider-docker
cat go.mod
go mod tidy
ls -l
go build
ls -l
go install
ls -l
ls -l ~/go/bin
```
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/c08f4879-10f6-48dd-a6d1-7b1a8d2dfce0" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/31cf43b7-1470-4057-915b-dd24a61e02da" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/440a538f-eb2d-4b3d-b71e-55a4acc461b3" />


## Lab - Using our custom terraform docker provider in Terraform manifest script
```
cd ~/terraform-sep2226-2025
git pull
cd Day5/custom-terraform-providers/test-docker-custom-terraform-provider
docker images | grep nginx
docker ps -a
cat main.tf
terraform plan
terraform apply --auto-approve
terraform show
docker images | grep nginx
docker ps -a
cat terraform.tfstate
```
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/dacd3d32-bbda-4f83-a814-257c86d75a0e" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/11ab2a25-fe7a-4498-9526-a4dd4fd74994" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/e3b64e68-1e41-4dd0-a9e4-e304a7abc139" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/c58a150f-cbe7-4bf2-a891-a703823d8cff" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/cc0ece86-f20d-439a-9977-31997b02df17" />

Update your main.tf as shown below
<pre>
terraform {
  required_providers {
    docker = {
      source = "tektutor/docker"
    }
  }
}

resource "docker_image" "nginx" {
  image_name = "bitnami/nginx:latest"
}

resource "docker_container" "ubuntu_container" {
   container_name = "ubuntu_c1"
   host_name = "c1"
   image_name = "tektutor/ubuntu-ansible-node:latest"
}

resource "docker_container" "rocky_container" {
   container_name = "ubuntu_c2"
   host_name = "c2"
   image_name = "tektutor/rocky-ansible-node:latest"
}	
</pre>

Check the plan and apply
```
terraform plan
terraform apply --auto-approve
docker images | grep nginx
docker ps
```
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/871fca64-d47b-4394-b9c6-39fb49861d05" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/78849f19-3a20-4551-abe6-a643f77893af" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/1aca91bc-6c18-47a9-a99f-3cfac59997dd" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/9e7f6782-55c5-4a41-b9ee-fcbd0123a6fa" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/20eaf5cd-9c40-4c5b-ab54-d6bd2c4c7e32" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/038153e6-0847-4410-81e0-401d5af8c9df" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/fc2df04d-6aeb-415d-96f5-90a2ec081cdf" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/38a3e98d-4651-472d-81b4-fd8482c88c4a" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/4623156b-a6eb-4954-a12d-d3105c1b83d1" />

Once you are done with this exercise, you may dispose the resource created using terraform
```
docker image | grep nginx
docker ps
terraform destroy --auto-approve
docker image | grep nginx
docker ps

```

<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/327faa4e-2e70-4107-b10b-18bae18c6ad3" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/0a233101-e433-4c95-9811-52bf32d72f09" />
<img width="1920" height="1168" alt="image" src="https://github.com/user-attachments/assets/0a52b3a1-72f8-44da-8198-70a5445a360c" />

## Info - Sentinel Overview
<pre>
- Sentinel is a policy-as-code framework developed by HashiCorp.
- It lets you define and enforce fine-grained policies across infrastructure and application workflows.
- Think of it as a guardrail system:
  - Terraform manages your infrastructure.
  - Sentinel enforces rules to ensure deployments follow your organizationâ€™s standards.  
</pre>

#### Motivation to use Policy-as-Code
<pre>
- Traditional governance relies on documents, manual reviews, or checklists. These are slow and error-prone.
- With Sentinel, you write rules in code that are:
  - Version-controlled (like Terraform files)
  - Testable
  - Automatically enforced during provisioning  
</pre>

#### Sentinel Policy Examples
Sentinel policies are written in a custom language (inspired by HCL and JSON).

Restricting Cloud Regions
<pre>
import "tfplan/v2" as tfplan

main = rule {
  all tfplan.resources.aws_instance as instances {
    all instances as r {
      r.applied.provider_config.region is "us-east-1"
    }
  }
}
</pre>

Ensures all AWS instances are launched only in us-east-1.

Enforce Minimum Instance Size
<pre>
import "tfplan/v2" as tfplan

main = rule {
  all tfplan.resources.aws_instance as instances {
    all instances as r {
      r.applied.instance_type in ["t2.medium", "t2.large", "m5.large"]
    }
  }
}  
</pre>

Blocks provisioning of small/unsupported instance types.

## Info - Install Jenkins and configuring Jenkins
<pre>
https://www.tektutor.org/ci-cd-with-maven-github-docker-jenkins/	
</pre>
